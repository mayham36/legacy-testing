<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panago Price Validator</title>
    <!-- Material Design 3 via Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-row" style="justify-content: flex-end;">
                <a href="/admin" class="admin-link">
                    <span class="material-icons">settings</span>
                    Admin
                </a>
            </div>
            <h1>Panago Price Validator</h1>
            <p class="subtitle">Select cities to validate pricing</p>
        </header>

        <!-- Master Document Section -->
        <div class="master-section">
            <h2>
                <span class="material-icons">description</span>
                Master Pricing Document
            </h2>
            <div class="master-info" id="masterInfo">
                {% if master_info %}
                <div class="master-loaded">
                    <span class="material-icons status-icon success">check_circle</span>
                    <div class="master-details">
                        <strong>{{ master_info.filename }}</strong>
                        <span class="meta">Uploaded: {{ master_info.uploaded_at }} | {{ master_info.total_prices }} prices</span>
                    </div>
                </div>
                {% else %}
                <div class="master-empty">
                    <span class="material-icons status-icon warning">warning</span>
                    <span>No master document loaded. Upload one to compare against expected prices.</span>
                </div>
                {% endif %}
            </div>
            <div class="master-upload">
                <input type="file" id="masterFile" accept=".xls,.xlsx" style="display:none" onchange="uploadMaster(this)">
                <button type="button" class="btn btn-outlined" onclick="document.getElementById('masterFile').click()">
                    <span class="material-icons">upload_file</span>
                    Upload Master Document
                </button>
            </div>
        </div>

        <div class="controls">
            <button type="button" class="btn btn-outlined" onclick="selectAll()">
                <span class="material-icons">select_all</span>
                Select All
            </button>
            <button type="button" class="btn btn-outlined" onclick="deselectAll()">
                <span class="material-icons">deselect</span>
                Deselect All
            </button>
            <span class="selection-count" id="selectionCount">0 selected</span>
        </div>

        <form id="validationForm" onsubmit="startValidation(event)">
            <div class="pricing-levels-grid">
                {% for pl_code, pl_data in pricing_levels.items() %}
                <div class="pl-section">
                    <h2 class="pl-title">
                        <span class="pl-code">{{ pl_code }}</span>
                        <span class="pl-name">{{ pl_data.name }}</span>
                    </h2>
                    <p class="pl-description">{{ pl_data.description }}</p>
                    <div class="cities-grid">
                        {% for city in pl_data.cities %}
                        <label class="city-tile" data-pl="{{ pl_code }}">
                            <input type="checkbox" name="cities" value="{{ pl_code }}:{{ city.city }}" onchange="updateCount()">
                            <div class="tile-content">
                                <span class="material-icons city-icon">location_city</span>
                                <span class="city-name">{{ city.city }}</span>
                            </div>
                            <span class="checkmark">
                                <span class="material-icons">check</span>
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="options-section">
                <label class="option-toggle">
                    <input type="checkbox" name="capture_cart" id="captureCart">
                    <span class="toggle-slider"></span>
                    <span class="option-label">Compare Menu vs Cart Prices</span>
                    <span class="option-hint">(Slower - adds each item to cart to verify prices)</span>
                </label>
            </div>

            <div class="actions">
                <button type="submit" class="btn btn-primary" id="runBtn">
                    <span class="material-icons">play_arrow</span>
                    Run Validation
                </button>
            </div>
        </form>

        <!-- Progress Section (hidden initially) -->
        <div id="progressSection" class="progress-section hidden">
            <div class="progress-card">
                <h3>Validation in Progress</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <p class="progress-message" id="progressMessage">Starting...</p>
                <p class="progress-time" id="progressTime" style="color: #666; font-size: 0.9em; margin-top: 8px;">
                    Elapsed: <span id="elapsedTime">0:00</span>
                </p>
                <div class="progress-spinner" id="spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Results Section (hidden initially) -->
        <div id="resultsSection" class="results-section hidden">
            <div class="results-card">
                <span class="material-icons result-icon success">check_circle</span>
                <h3>Validation Complete</h3>
                <p class="result-time" id="resultTime" style="color: #666; font-size: 0.9em; margin-bottom: 8px;"></p>
                <p class="result-summary" id="resultSummary"></p>
                <button type="button" class="btn btn-primary" onclick="downloadResults()">
                    <span class="material-icons">download</span>
                    Download Results
                </button>
                <button type="button" class="btn btn-outlined" onclick="resetForm()">
                    <span class="material-icons">refresh</span>
                    Run Again
                </button>
            </div>
        </div>

        <!-- Error Section (hidden initially) -->
        <div id="errorSection" class="error-section hidden">
            <div class="error-card">
                <span class="material-icons result-icon error">error</span>
                <h3>Validation Failed</h3>
                <p class="error-message" id="errorMessage"></p>
                <button type="button" class="btn btn-outlined" onclick="resetForm()">
                    <span class="material-icons">refresh</span>
                    Try Again
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container for milestone notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        let currentJobId = null;
        let eventSource = null;
        let seenMilestones = 0;
        let totalPLs = 0;

        function updateCount() {
            const checked = document.querySelectorAll('input[name="cities"]:checked').length;
            document.getElementById('selectionCount').textContent = checked + ' selected';
        }

        function selectAll() {
            document.querySelectorAll('input[name="cities"]').forEach(cb => cb.checked = true);
            updateCount();
        }

        function deselectAll() {
            document.querySelectorAll('input[name="cities"]').forEach(cb => cb.checked = false);
            updateCount();
        }

        // --- Milestone Notification System ---
        console.log('[Panago] Milestone notification system loaded');

        const TOAST_MAX = 3;
        const TOAST_DURATION = 5000;

        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                await Notification.requestPermission();
            }
        }

        function showMilestoneToast(milestone) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast toast-success';

            const failText = milestone.cities_failed > 0
                ? ' (' + milestone.cities_failed + ' failed)' : '';
            toast.innerHTML =
                '<span class="material-icons toast-icon">check_circle</span>' +
                '<span>' + milestone.pl_code + ' Complete &mdash; ' + milestone.pl_name +
                ': ' + milestone.cities_succeeded + '/' + milestone.cities_total +
                ' cities' + failText + '</span>';

            container.appendChild(toast);

            // Enforce max visible toasts
            while (container.children.length > TOAST_MAX) {
                container.removeChild(container.firstChild);
            }

            setTimeout(function() { toast.remove(); }, TOAST_DURATION);
        }

        function notifyMilestone(milestone) {
            var isHidden = document.visibilityState === 'hidden';

            if (isHidden && 'Notification' in window && Notification.permission === 'granted') {
                // Always send native notifications for backgrounded tabs
                var failText = milestone.cities_failed > 0
                    ? ' (' + milestone.cities_failed + ' failed)' : '';
                var n = new Notification(milestone.pl_code + ' Complete', {
                    body: milestone.pl_name + ' \u2014 ' + milestone.cities_succeeded +
                          '/' + milestone.cities_total + ' cities validated' + failText,
                    tag: 'panago-pl-' + milestone.pl_code,
                });
                n.onclick = function() { window.focus(); n.close(); };
            } else if (totalPLs > 1) {
                // Only show in-page toasts when multiple PLs are selected,
                // otherwise the toast appears simultaneously with the success
                // screen and feels redundant
                showMilestoneToast(milestone);
            }
        }

        // --- End Milestone Notification System ---

        async function uploadMaster(input) {
            if (!input.files || input.files.length === 0) return;

            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);

            const btn = input.previousElementSibling || document.querySelector('.master-upload button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="material-icons">hourglass_empty</span> Uploading...';
            btn.disabled = true;

            try {
                const response = await fetch('/upload-master', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.error) {
                    alert('Upload failed: ' + data.error);
                } else {
                    // Refresh page to show new master info
                    window.location.reload();
                }
            } catch (error) {
                alert('Upload failed: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                input.value = '';
            }
        }

        async function startValidation(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const cities = formData.getAll('cities');

            if (cities.length === 0) {
                alert('Please select at least one city');
                return;
            }

            // Request notification permission before starting
            await requestNotificationPermission();

            // Reset milestone tracking
            seenMilestones = 0;

            // Count distinct PLs selected -- skip milestone toasts if only 1 PL
            var plSet = {};
            cities.forEach(function(c) { plSet[c.split(':')[0]] = true; });
            totalPLs = Object.keys(plSet).length;

            // Hide form, show progress
            document.getElementById('validationForm').classList.add('hidden');
            document.querySelector('.controls').classList.add('hidden');
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');

            try {
                const response = await fetch('/run', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.error) {
                    showError(data.error);
                    return;
                }

                currentJobId = data.job_id;
                startPolling(currentJobId);

            } catch (error) {
                showError('Failed to start validation: ' + error.message);
            }
        }

        function startPolling(jobId) {
            // Use SSE for real-time updates
            eventSource = new EventSource('/stream/' + jobId);
            var jobCompleted = false;

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (data.error) {
                    eventSource.close();
                    showError(data.error);
                    return;
                }

                updateProgress(data);

                if (data.status === 'completed') {
                    jobCompleted = true;
                    eventSource.close();
                    showResults(data);
                } else if (data.status === 'error') {
                    eventSource.close();
                    showError(data.message);
                }
            };

            // Listen for milestone events (named SSE events)
            // Milestones are sent before the data event, so they arrive
            // before the completed status closes the EventSource
            eventSource.addEventListener('milestone', function(event) {
                var milestone = JSON.parse(event.data);
                console.log('[Panago] Milestone received:', milestone);
                notifyMilestone(milestone);
            });

            eventSource.onerror = function() {
                eventSource.close();
                // Fallback to polling (milestones available via job state)
                pollStatus(jobId);
            };
        }

        async function pollStatus(jobId) {
            try {
                const response = await fetch('/status/' + jobId);
                const data = await response.json();

                if (data.error) {
                    showError(data.error);
                    return;
                }

                updateProgress(data);

                // Deliver any milestones missed during SSE disconnect
                var milestones = data.milestones || [];
                for (var i = seenMilestones; i < milestones.length; i++) {
                    notifyMilestone(milestones[i]);
                }
                seenMilestones = milestones.length;

                if (data.status === 'completed') {
                    showResults(data);
                } else if (data.status === 'error') {
                    showError(data.message);
                } else {
                    // Continue polling
                    setTimeout(function() { pollStatus(jobId); }, 2000);
                }
            } catch (error) {
                showError('Failed to check status: ' + error.message);
            }
        }

        function updateProgress(data) {
            document.getElementById('progressBar').style.width = data.progress + '%';
            document.getElementById('progressMessage').textContent = data.message;

            // Update elapsed time
            if (data.elapsed_seconds !== undefined) {
                const elapsed = Math.floor(data.elapsed_seconds);
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                document.getElementById('elapsedTime').textContent =
                    mins + ':' + secs.toString().padStart(2, '0');
            }
        }

        function showResults(data) {
            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('resultSummary').textContent = data.message;

            // Display final elapsed time
            if (data.elapsed_seconds !== undefined) {
                const elapsed = Math.floor(data.elapsed_seconds);
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                document.getElementById('resultTime').textContent =
                    'Completed in ' + mins + 'm ' + secs + 's';
            }
        }

        function showError(message) {
            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('errorSection').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        function downloadResults() {
            if (currentJobId) {
                window.location.href = '/download/' + currentJobId;
            }
        }

        function resetForm() {
            document.getElementById('validationForm').classList.remove('hidden');
            document.querySelector('.controls').classList.remove('hidden');
            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('progressBar').style.width = '0%';
            currentJobId = null;
        }
    </script>
</body>
</html>
