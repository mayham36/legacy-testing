<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - City Configuration</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-row">
                <a href="/" class="back-link">
                    <span class="material-icons">arrow_back</span>
                    Back to Validator
                </a>
            </div>
            <h1>City Configuration</h1>
            <p class="subtitle">Manage cities and provinces for validation</p>
        </header>

        <div class="admin-controls">
            <button type="button" class="btn btn-primary" onclick="showAddProvinceModal()">
                <span class="material-icons">add</span>
                Add Province
            </button>
            <button type="button" class="btn btn-primary" onclick="showAddCityModal()">
                <span class="material-icons">add_location</span>
                Add City
            </button>
        </div>

        <div class="provinces-grid">
            {% for province, cities in provinces.items() %}
            <div class="province-section admin-province" data-province="{{ province }}">
                <div class="province-header">
                    <h2 class="province-title">{{ province }}</h2>
                    <button type="button" class="btn-icon delete-province" onclick="deleteProvince('{{ province }}')" title="Delete province">
                        <span class="material-icons">delete</span>
                    </button>
                </div>
                <div class="cities-list">
                    {% if cities %}
                        {% for city in cities %}
                        <div class="city-item" data-city="{{ city.city }}">
                            <div class="city-info">
                                <span class="material-icons city-icon-small">location_city</span>
                                <span class="city-name">{{ city.city }}</span>
                                {% if city.store_name and city.store_name != city.city %}
                                <span class="store-name">({{ city.store_name }})</span>
                                {% endif %}
                            </div>
                            <button type="button" class="btn-icon delete-city" onclick="deleteCity('{{ province }}', '{{ city.city }}')" title="Delete city">
                                <span class="material-icons">close</span>
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="empty-province">No cities configured</p>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <span class="material-icons">map</span>
                <p>No provinces configured yet</p>
                <button type="button" class="btn btn-primary" onclick="showAddProvinceModal()">
                    Add your first province
                </button>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Add Province Modal -->
    <div id="addProvinceModal" class="modal hidden">
        <div class="modal-backdrop" onclick="closeModals()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Province</h3>
                <button type="button" class="btn-icon" onclick="closeModals()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="addProvinceForm" onsubmit="addProvince(event)">
                <div class="form-group">
                    <label for="provinceCode">Province Code</label>
                    <input type="text" id="provinceCode" name="province" placeholder="e.g., BC, ON, QC" maxlength="2" required pattern="[A-Za-z]{2}">
                    <span class="form-hint">2-letter province code</span>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outlined" onclick="closeModals()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Province</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add City Modal -->
    <div id="addCityModal" class="modal hidden">
        <div class="modal-backdrop" onclick="closeModals()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add City</h3>
                <button type="button" class="btn-icon" onclick="closeModals()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <form id="addCityForm" onsubmit="addCity(event)">
                <div class="form-group">
                    <label for="cityProvince">Province</label>
                    <select id="cityProvince" name="province" required>
                        <option value="">Select a province</option>
                        {% for province in provinces.keys() %}
                        <option value="{{ province }}">{{ province }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="cityName">City Name</label>
                    <input type="text" id="cityName" name="city" placeholder="e.g., Vancouver" required>
                </div>
                <div class="form-group">
                    <label for="storeName">Store Name (optional)</label>
                    <input type="text" id="storeName" name="store_name" placeholder="Defaults to city name">
                    <span class="form-hint">Leave blank to use city name</span>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outlined" onclick="closeModals()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add City</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="confirmModal" class="modal hidden">
        <div class="modal-backdrop" onclick="closeModals()"></div>
        <div class="modal-content modal-confirm">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirm Delete</h3>
                <button type="button" class="btn-icon" onclick="closeModals()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <p id="confirmMessage">Are you sure you want to delete this item?</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-outlined" onclick="closeModals()">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmBtn" onclick="confirmAction()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden">
        <span class="material-icons toast-icon" id="toastIcon">check_circle</span>
        <span id="toastMessage"></span>
    </div>

    <script>
        let pendingAction = null;

        function showAddProvinceModal() {
            document.getElementById('addProvinceModal').classList.remove('hidden');
            document.getElementById('provinceCode').focus();
        }

        function showAddCityModal() {
            document.getElementById('addCityModal').classList.remove('hidden');
            document.getElementById('cityProvince').focus();
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));
            pendingAction = null;
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');

            msg.textContent = message;
            icon.textContent = isError ? 'error' : 'check_circle';
            toast.className = 'toast' + (isError ? ' toast-error' : ' toast-success');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        async function addProvince(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            try {
                const response = await fetch('/admin/provinces', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (!response.ok) {
                    showToast(data.error, true);
                    return;
                }

                showToast(data.message);
                setTimeout(() => location.reload(), 500);
            } catch (error) {
                showToast('Failed to add province: ' + error.message, true);
            }
        }

        async function addCity(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            try {
                const response = await fetch('/admin/cities', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (!response.ok) {
                    showToast(data.error, true);
                    return;
                }

                showToast(data.message);
                setTimeout(() => location.reload(), 500);
            } catch (error) {
                showToast('Failed to add city: ' + error.message, true);
            }
        }

        function deleteCity(province, city) {
            pendingAction = async () => {
                try {
                    const response = await fetch(`/admin/cities/${encodeURIComponent(province)}/${encodeURIComponent(city)}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();

                    if (!response.ok) {
                        showToast(data.error, true);
                        return;
                    }

                    showToast(data.message);
                    // Remove from DOM
                    const cityItem = document.querySelector(`[data-province="${province}"] [data-city="${city}"]`);
                    if (cityItem) cityItem.remove();
                } catch (error) {
                    showToast('Failed to delete city: ' + error.message, true);
                }
            };

            document.getElementById('confirmTitle').textContent = 'Delete City';
            document.getElementById('confirmMessage').textContent = `Are you sure you want to remove "${city}" from ${province}?`;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function deleteProvince(province) {
            pendingAction = async () => {
                try {
                    const response = await fetch(`/admin/provinces/${encodeURIComponent(province)}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();

                    if (!response.ok) {
                        showToast(data.error, true);
                        return;
                    }

                    showToast(data.message);
                    setTimeout(() => location.reload(), 500);
                } catch (error) {
                    showToast('Failed to delete province: ' + error.message, true);
                }
            };

            document.getElementById('confirmTitle').textContent = 'Delete Province';
            document.getElementById('confirmMessage').textContent = `Are you sure you want to remove province "${province}"? The province must be empty.`;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function confirmAction() {
            closeModals();
            if (pendingAction) {
                pendingAction();
                pendingAction = null;
            }
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModals();
        });
    </script>
</body>
</html>
